<!DOCTYPE html>
<!--
Copyright 2017 by Pascal Stoop
-->
<html>
  <head>
      <title>Exercise 2-3</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" type="text/css" href="core/lib/semantic-ui/semantic.min.css">

      <style> 
        .aspect-container {
          position: relative;
          padding: 0 0 50% 0;
          height: 0;
          overflow: hidden;
        }
        #myCanvas {
          width: 100%; 
          height: 100%; 
          position:absolute;
          top:0;
          left:0;
        }
        #link {
          display: none;
        }
      </style>

      <script src="core/lib/jquery-3.2.1.js"></script>
      <script src="core/lib/semantic-ui/semantic.min.js"></script>

      <script>
        var refCanvas = undefined;
        var ctx = null;
        var mouseClicked = false;
        
        var Commands = {
          clearall: "clearall",
          draw: "draw"
        }
        
        function init() {
          refCanvas = document.getElementById("myCanvas");
          if (refCanvas.getContext) {
            ctx = refCanvas.getContext('2d', {alpha: true});
            resizeCanvas();
          }
          
          window.addEventListener("resize", function() {
            resizeCanvas();
          });
          
          $("#myCanvas").on("mousemove", function(e) {
            if (mouseClicked) {
              var pos = getPositionFromEvent(e, refCanvas);
              paint(Commands.draw, pos);
            }
          });
          
          $("#myCanvas").on("mousedown", function(e) {
            var pos = getPositionFromEvent(e, refCanvas);
            paint(Commands.draw, pos);
            mouseClicked = true;
          });
          $("#myCanvas").on("mouseup", function(e) {
            mouseClicked = false;
          });
          
          $("#b-screenshot").on("click", function() {
            if(refCanvas.msToBlob) {
              //IE
              window.navigator.msSaveBlob(refCanvas.msToBlob(), 'img.png');
            }
            else {
              //other browsers
              var link = document.getElementById("link");
              link.setAttribute('download', 'img.png');
              link.setAttribute('href', refCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream"));
              link.click();
            }
          });
          
        };

        function getPositionFromEvent(event, refCanvas) {
          var result = { x: 0, y:0};

          if (event.x != undefined && event.y != undefined) {
            result.x = event.x;
            result.y = event.y;
          }
          else { 
            result.x = event.clientX;
            result.y = event.clientY;
          }
          
          //calc position relative to canvas
          var eInfo = refCanvas.getBoundingClientRect();
          result.x -= Math.floor(eInfo.left);
          result.y -= Math.floor(eInfo.top);
          console.log(result);
          return result;
        }

        function resizeCanvas() {
          var boxWidth = refCanvas.clientWidth;
          var boxHeight = refCanvas.clientHeight;
          refCanvas.width = boxWidth;
          refCanvas.height = boxHeight;
          paint(Commands.clearall, null);
        }
        
        function paint(cmd, posData) {
          if (ctx != null) {
            if ((cmd == Commands.draw) && (posData != null)) {
              ctx.fillStyle = ctx.strokeStyle = "#" + $("#i-colorhex").val();
              ctx.globalAlpha = $("#i-alphavalue").val();
              ctx.globalCompositeOperation = $("#i-compositeoperation").val();
              
              var rectSize = $("#i-rectsize").val();
              var tempDS = $("#i-drawstyle").val();
              
              if ($("#i-type").val() === "rect") {
                ctx[tempDS + "Rect"](posData.x - rectSize/2, posData.y - rectSize/2, rectSize, rectSize);
              }
              else {
                ctx.beginPath();
                ctx.arc(posData.x, posData.y, rectSize, 0, 2*Math.PI);
                ctx[tempDS]();
              }
              
              
            }
            else {
              ctx.clearRect(0, 0, refCanvas.width, refCanvas.height);
            }
          }
        }
        
        $(function() {
            init();
        });
      </script>
  </head>
  <body>
    <div class="ui raised padded container segment">
      <div class="ui segments">
        <div class="ui segment">
          <h3>Canvas - Exercise 2-3 (Paint)</h3>
        </div>
        <div class="ui segment">
          <button id="b-clearall" class="ui button">Clear All</button>
          <select class="ui dropdown" id="i-type">
            <option value="rect">rect</option>
            <option value="circle">circle</option>
          </select>
          <select class="ui dropdown" id="i-rectsize">
            <option value="1">1x1 px</option>
            <option value="2">2x2 px</option>
            <option value="4" selected="selected">4x4 px</option>
            <option value="8">8x8 px</option>
            <option value="16">16x16 px</option>
            <option value="32">32x32 px</option>
            <option value="64">64x64 px</option>
            <option value="128">128x128 px</option>
          </select>
          <select class="ui dropdown" id="i-drawstyle">
            <option value="fill">fill</option>
            <option value="stroke">stroke</option>
          </select>
          <select class="ui dropdown" id="i-strokewidth">
            <option value="1">1px (stroke)</option>
            <option value="2">2px (stroke)</option>
            <option value="4" selected="selected">4px (stroke)</option>
            <option value="6">6px (stroke)</option>
            <option value="8">8px (stroke)</option>
            <option value="10">10px (stroke)</option>
          </select>
          <div class="ui labeled input">
            <div class="ui label">
              Color-Hex
            </div>
            <input id="i-colorhex" type="text" value="ff0000">
          </div>
          <select class="ui dropdown" id="i-alphavalue">
            <option value="0.2">Alpha (0.2)</option>
            <option value="0.4">Alpha (0.4)</option>
            <option value="0.6" selected="selected">Alpha (0.6)</option>
            <option value="0.8">Alpha (0.8)</option>
            <option value="1">Alpha (1.0)</option>
          </select>
          <select class="ui dropdown" id="i-compositeoperation">
            <option value="source-over">source-over</option>
            <option value="source-in">source-in</option>
            <option value="source-out">source-out</option>
            <option value="source-atop">source-atop</option>
            <option value="destination-over">destination-over</option>
            <option value="destination-in">destination-in</option>
            <option value="copy">copy</option>
            <option value="xor">xor</option>
            <option value="destination-out">destination-out</option>
            <option value="destination-atop">destination-atop</option>
            <option value="lighter">lighter</option>
          </select>
        </div>
        <div class="ui segment">
          <!-- area for canvas-element -->
          <div class="aspect-container">
            <canvas id="myCanvas" width="100" height="100"></canvas >
          </div>
        </div>
        <div class="ui segment">
          <button id="b-screenshot" class="ui button">Create Screenshot</button>
          <a id="link"></a>
        </div>
      </div>
    </div>
  </body>
</html>
